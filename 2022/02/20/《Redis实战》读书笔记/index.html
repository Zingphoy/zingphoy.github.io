<!DOCTYPE html>


<html lang="zh-CN" >


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="computer science, blog, life, techique" />
   
  <meta name="description" content="一名QA，不甘平庸的QA" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    《Redis实战》读书笔记 |  Zingphoy
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-127980698-1', 'auto');
ga('send', 'pageview');

</script>



  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?b1b2a6b0e5bb9dd4408632cb65ab0a45";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

</html>

<body>
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-《Redis实战》读书笔记" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  《Redis实战》读书笔记
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/02/20/《Redis实战》读书笔记/" class="article-date">
  <time datetime="2022-02-20T09:25:38.000Z" itemprop="datePublished">2022-02-20</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/读书笔记/">读书笔记</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">2.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">9 分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="《Redis实战》"><a href="#《Redis实战》" class="headerlink" title="《Redis实战》"></a>《Redis实战》</h1><p><a href="https://book.douban.com/subject/26612779/" target="_blank" rel="noopener">《Redis实战》豆瓣链接</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本书面向 Redis 初学者，全书非常贯彻”实战“二字，基本是以应用案例驱动的一本书，非常适合想跟着案例讲解一步步编码学习的读者，但也是因为这个特色导致书本欠缺深度和广度，不少地方更是显得啰嗦无聊。</p>
<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ol>
<li>Redis 基本命令和概念</li>
<li>Redis 各类数据结构的实际应用案例，有些比较有启发性，如倒排索引的实现</li>
</ol>
<h2 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h2><ol>
<li>局限于 Redis 单机技术，欠缺 Redis 集群环境上的技术讲解</li>
<li>应用案例的代码注释虽多但欠缺图解不易理解，不少浅显的代码会用一段文本去解释，着实有些啰嗦并降低了整体可读性，需要跟着作者的思路细看，效率低（故我没细看代码）</li>
</ol>
<h2 id="一个补充"><a href="#一个补充" class="headerlink" title="一个补充"></a>一个补充</h2><p>Redis 创始人 Antirez 博客 <a href="http://antirez.com/news/135" target="_blank" rel="noopener">Programming and Writing</a> 写到编程和写作之间的异同之处，如下是文章摘抄：</p>
<blockquote>
<p>The most obvious parallel between the two activities is that in both of them you write something. Code is not prose written in a natural language, yet it has a set of fixed rules (a grammar), certain forms that most programmers will understand as natural and others that, while formally correct, will sound hard to grasp.<br>There is, however, a much deeper connection between the two activities: a good program and a good novel are both the sum of local and global elements that work well. Good code must be composed of well written and readable single statements, but overall the different parts of the program must be orthogonal, designed in a coherent way, and have clean interactions. A good novel must also succeed in the same two scales of the micro and the macro. Sentences must be well written, but the overall structure and relationship between the parts is also crucial.<br>A less structural link between programming and writing is in the drive you need when approaching one or the other: <strong>to succeed you need to make progresses, and to make progresses you have to be consistent.</strong> There is extensive agreement on the fact that programs and novels don’t write themselves, yet. <strong>Twenty years of writing code helped me immensely with this aspect; I knew that things happen only if you sit every day and write: one day one hundred words, the other day two thousands, but rare is the day I don’t put words on the page.</strong> And if you have written code that is not just a “filler” for a bigger system, but a creation of your own, you know that writer block also happens in programming. The only difference is that for most people you are an engineer, hence, if you don’t work, you are lazy. The same laziness, in the case of an artist, will assume the shape of a fascinating part of the creative process.</p>
</blockquote>
<hr>
<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><ul>
<li>快照（snapshotting）<ul>
<li>BGSAVE 命令，fork 子进程讲快照写入硬盘，父进程继续处理命令请求</li>
<li>SAVE 命令，阻塞命令执行直至快照创建完毕，一般在没有足够内存执行 BGSAVE 的情况下使用</li>
</ul>
</li>
<li>AOF（append-only file）<ul>
<li>被执行的写命令写到 AOF 文件末尾，以此来记录数据发生的变化，Redis 只要从头到尾重新执行一次 AOF 文件的所有命令，就可以恢复 AOF 文件所记录的数据集</li>
<li>随着 Redis 运行，AOF 文件的体积会不断增大，从而消耗存储空间，BGREWRITEAOF 命令通过子进程移除 AOF 文件中的冗余命令来重写 AOF 文件降低体积</li>
<li>appendfsync 选项<ul>
<li>always：每个 Redis 写命令都同步写入硬盘，会严重降低 Redis 速度</li>
<li>everysec：每秒执行一次同步，显式地将多个写命令同步到硬盘</li>
<li>no：让操作系统来决定应该何时进行同步</li>
</ul>
</li>
</ul>
</li>
<li>复制（replication）【引入外部资料补充】<ul>
<li>主从链：随着负载上升，主服务器无法快速地更新所有从服务器，或者因为重新连接和重新同步从服务器导致系统超载（主服务器网络带宽打满），可以创建一个由 Redis 主从节点组成的中间层来分担主服务器的复制工作（中间层的从服务器作为更下层节点的主服务器）</li>
<li>Redis 不支持“主主复制”</li>
<li>主从复制启动过程如下【表格1】</li>
<li>主从复制存在数据延迟或数据过期，应用层需要将此因素考虑进去，如果不能容忍延迟或过期，需要应用层自行添加外围监控</li>
<li>规避全量复制，造成全量复制原因有<ul>
<li>节点RunID不匹配：master 节点重启（RunID发生变化），slave 保存 master 节点老的 RunID，与新的 RunID 不一致，就会采取一次全量复制</li>
<li>复制积压缓冲区不足</li>
</ul>
</li>
<li>规避复制风暴<ul>
<li>单主节点复制风暴：主节点重启，多从节点全量复制 —— 引入树状主从链来降低顶层主节点的网络开销，但是会带来运维复杂性，增加手动或自动处理故障转移的难度</li>
<li>单机器复制风暴：单机器上部署较多主节点，本机器宕机重启，机器上运行的主节点实例发生大量全量复制 —— 主节点分散部署到不同机器上</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>【表格1】</p>
<table>
<thead>
<tr>
<th>步骤</th>
<th>主服务器操作</th>
<th>从服务器操作</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>等待命令进入</td>
<td>连接（或重新连接）主服务器，发送 SYNC 命令</td>
</tr>
<tr>
<td>2</td>
<td>开始执行 BGSAVE，使用缓冲区记录 BGSAVE 之后执行的所有写命令</td>
<td>根据配置选项来决定是继续使用现有的数据（如果有）来处理客户端的命令请求，还是向发送请求的客户端返回错误</td>
</tr>
<tr>
<td>3</td>
<td>BGSAVE 执行结束，向从服务器发送快照文件，并在发送期间继续使用缓冲记录被执行的写命令</td>
<td>丢弃所有旧数据（如果有），开始载入主服务器发过来的快照</td>
</tr>
<tr>
<td>4</td>
<td>块找文件发送完毕，开始向从服务器发送存储在缓冲器里的写命令</td>
<td>完成对快照文件的解释操作，像往常一样开始接受命令请求</td>
</tr>
<tr>
<td>5</td>
<td>缓冲区存储的写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令</td>
<td>执行主服务器发来的所有存储在缓冲区里的写命令；从现在开始，接收并执行主服务器传来的每个写命令</td>
</tr>
</tbody></table>
<h2 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h2><ul>
<li>Redis事务不支持回滚，但具备原子性（要么都执行，要么都不执行，但并不代表执行不会出错，出错也没有 rollback）</li>
<li>使用 <code>multi</code> &amp; <code>exec</code> 实现多个命令的一次性、按顺序地执行（集群下效果不明）；流程是 开始事务-&gt;命令如入队-&gt;执行事务；意义似乎只是减少网络通信从而提升性能</li>
<li>pipeline 和事务是两个完全不同的概念，pipeline是客户端的行为，实现单次批量传输命令给服务端从而减少网络开销，对于服务端是透明的，pipeline 没有原子性（而事务是服务端实现的，保证原子性）</li>
<li><a href="https://www.cnblogs.com/Howinfun/p/12774398.html" target="_blank" rel="noopener">Redis事务的一份好资料</a>，简述 Redis 事务源码实现，以及 Redis 事务与 MySQL 事务的作用对比</li>
<li>Lua 脚本具备原子性，当脚本运行时间超过 lua-time-limit 选项指定的时间之后，执行 SCRIPT KILL 命令可以杀死正在运行的脚本，但如果脚本存在写操作会使得数据不一致</li>
</ul>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><ul>
<li>单机锁<ul>
<li><code>watch</code> 命令监视数据是否被修改，可以实现乐观锁</li>
<li><code>setnx</code> + 超时释放 + uuid 持锁标记 + Lua 脚本释放锁</li>
</ul>
</li>
<li>集群锁<ul>
<li><a href="https://redis.io/topics/distlock" target="_blank" rel="noopener">RedLock算法</a>（书中没讲解，只知道这个概念但没去理解）</li>
</ul>
</li>
</ul>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><ul>
<li>计数信号量（集群下表现未阐述）<ul>
<li>基于本机时间戳的 zset 排名（缺点：机器时之间间差异导致锁的不合理分配，不公平）</li>
<li>客户端对计数器进行自增操作，谁先自增成功谁获得信号量（解决机器之间时间差异的问题）</li>
</ul>
</li>
</ul>
<h2 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h2><ul>
<li>多级的任务队列<ul>
<li>多个不同优先级的任务队列，如高、中、低三个任务队列</li>
<li><a href="https://github.com/josiahcarlson/rpqueue" target="_blank" rel="noopener">redis优先级队列 - rpqueue</a></li>
</ul>
</li>
<li>延迟任务<ul>
<li>zset 存储任务预期运行的时间戳（以及任务相关的其他要素），外部轮询第一个元素的运行时间是否满足</li>
</ul>
</li>
<li>消息拉取<ul>
<li><code>publish</code> &amp; <code>subscribe</code> 命令，要求命令接收方一直在线，否则会丢消息</li>
<li>群组聊天的实现，需要三类表：一类是群组包含的成员名单（群id对应的成员id）、一类是群组发送的所有消息（所有消息id和消息体）、一类是成员在不同群组的消息消费进度（消费到什么id的消息）</li>
</ul>
</li>
</ul>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><ul>
<li>实现倒排索引<ul>
<li>key 为分词结果（比如一个单词或一个短语），value 为 key 所出现的位置列表</li>
<li>通过 redis 交集、并集、差集操作，实现搜索语义</li>
<li>通过 redis sort 对搜索结果进行排序，或通过有序集合实现排序</li>
</ul>
</li>
</ul>
<h2 id="线程问题（补充）"><a href="#线程问题（补充）" class="headerlink" title="线程问题（补充）"></a>线程问题（补充）</h2><ul>
<li>Redis 单线程<ul>
<li>执行 Redis 命令的核心模块是单线程（所以命令之间是串行的确实没错），但是整个 Redis 实例并不只有一个线程，Redis 其他模块有各自的线程</li>
<li>Redis 瓶颈一般不在 CPU，而是在内存和网络。如果要尽可能提高 CPU 利用率，可以通过部署多 Redis 实例</li>
<li>网络 I/O 读写使用多线程，更多拓展知识见<a href="https://strikefreedom.top/multiple-threaded-network-model-in-redis" target="_blank" rel="noopener">他人网络博文</a></li>
</ul>
</li>
</ul>

      
      <!-- reward -->
      
      <div id="reward-btn">
        打赏
      </div>
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong>
              本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://zingphoy.github.io/2022/02/20/《Redis实战》读书笔记/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
    
      <a href="/2021/07/11/Monkey测试的进化之路/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Monkey测试的进化之路</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'lEXlYo1CeMpXzh2xpIltjyfz-gzGzoHsz',
        app_key: 'cFRtsPTW0nzHu7wC21T3FXtH',
        path: window.location.pathname,
        notify: 'true',
        verify: 'true',
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2017-2022
        Zingphoy Han
      </li>
      <li>
        
        Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/Me.png" alt="Zingphoy"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>一块钱一个俯卧撑 O_O</p>
  <div class="reward-box">
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/WechatPay.jpeg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['技术、健身、欢乐', '一名QA，却不甘于只做QA', '梦想是拥有一间自己的健身房'],
      startDelay: 500,
      typeSpeed: 150,
      loop: false,
      backSpeed: 50,
      showCursor: true
    });
  } catch (err) {
  }

</script>



<script src="/js/tocbot.min.js"></script>
<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>




<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>

  <script src="/js/clickLove.js"></script>


    
  </div>
</body>

</html>